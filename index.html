<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>What the Dog Doing?</title>
<style>
:root{
  --bg:#0b0e14;
  --sky1:#142034;
  --sky2:#2a4a70;
  --panel:#0d111bcc;
  --ink:#f6f8ff;
  --accent:#f04561;
  --mint:#68efc8;
  --warn:#ffd06a;
}
*{box-sizing:border-box}
html,body{width:100%;height:100%;margin:0;overflow:hidden;background:var(--bg);font-family:Trebuchet MS,Avenir Next,Segoe UI,sans-serif;color:var(--ink)}
body{touch-action:none}
canvas{display:block;width:100%;height:100%}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
(()=>{
  const cnv=document.getElementById('c'),ctx=cnv.getContext('2d');

  let W=360,H=740,DPR=1,last=0;
  let camX=0;

  const WORLD_W=7200;
  const GRAV=2200;
  const FLOOR_Y=440;
  const MAX_DX=410;
  const MOVE_ACC=1700;
  const MOVE_DEC=1300;
  const AIR_ACC=980;
  const JUMP_V=760;
  const WALL_JUMP_X=390;
  const WALL_JUMP_Y=730;
  const TUT=[
    {k:'right',t:'Hold RIGHT zone to run'},
    {k:'jump',t:'Tap center to jump'},
    {k:'walljump',t:'Jump while touching a wall'},
    {k:'slide',t:'Swipe down to slide'},
    {k:'grapple',t:'Hold near yellow ring to grapple'}
  ];

  let audio=null;

  const s={
    start:0,dead:0,win:0,
    t:0,
    score:0,best:+localStorage.hd2_best||0,combo:0,comboT:0,
    x:130,y:200,w:34,h:24,dx:0,dy:0,onG:0,onW:0,face:1,
    coyote:0,jb:0,
    slide:0,
    grap:0,gx:0,gy:0,gl:0,
    boost:0,
    notes:0,coffee:0,
    hint:11,ti:0,
    hold:0,
    r:""
  };

  let acts={l:0,r:0,d:0,j:0};
  let pid=-1,downX=0,downY=0,downT=0;

  const seg=[];
  const walls=[];
  const hazards=[];
  const coins=[];
  const boosts=[];
  const anchors=[];
  const particles=[];

  const imgs={};

  function img(n){const i=new Image();i.src='black_scottish_terrier_dog_with_red_scarf/rotations/'+n+'.png';return i}
  imgs.e=img('east');
  imgs.w=img('west');
  imgs.ne=img('north-east');
  imgs.nw=img('north-west');
  imgs.se=img('south-east');
  imgs.sw=img('south-west');

  function clamp(v,a,b){return v<a?a:v>b?b:v}
  function lerp(a,b,t){return a+(b-a)*t}
  function rndi(a,b){return a+Math.random()*(b-a)}

  function beep(f,d,t,v){
    if(!audio)return;
    const o=audio.createOscillator(),g=audio.createGain();
    o.type=t||'triangle';o.frequency.value=f;g.gain.value=v||.03;
    g.gain.exponentialRampToValueAtTime(.0001,audio.currentTime+d);
    o.connect(g).connect(audio.destination);o.start();o.stop(audio.currentTime+d);
  }

  function burst(x,y,c,n,vx,vy){
    for(let i=0;i<n;i++){
      const a=Math.random()*Math.PI*2,sp=Math.random()*70+40;
      particles.push({x,y,dx:Math.cos(a)*sp+(vx||0),dy:Math.sin(a)*sp+(vy||0),t:rndi(.2,.55),c});
    }
  }

  function resize(){
    DPR=Math.max(1,Math.min(2,devicePixelRatio||1));
    W=Math.max(320,innerWidth|0);
    H=Math.max(560,innerHeight|0);
    cnv.width=(W*DPR)|0;
    cnv.height=(H*DPR)|0;
    ctx.setTransform(DPR,0,0,DPR,0,0);
    ctx.imageSmoothingEnabled=false;
  }

  function addLevel(){
    seg.length=0;walls.length=0;hazards.length=0;coins.length=0;boosts.length=0;anchors.length=0;

    seg.push({x:0,y:FLOOR_Y,w:WORLD_W,h:50});
    // Structured intro so each mechanic is discoverable in order.
    walls.push({x:740,y:FLOOR_Y-130,w:12,h:130});
    hazards.push({x:980,y:FLOOR_Y-12,w:36,h:12});
    anchors.push({x:1240,y:FLOOR_Y-120});
    coins.push({x:520,y:FLOOR_Y-45,r:8,g:0});
    boosts.push({x:1110,y:FLOOR_Y-35,w:16,h:16,g:0});

    let x=260;
    for(let i=0;i<74;i++){
      const w=rndi(95,160),gap=rndi(60,130),h=rndi(16,26);
      const up=(i%3===0?-rndi(18,52):i%5===0?rndi(20,55):0);
      seg.push({x,y:FLOOR_Y+up,w,h});

      if(i%4===0){
        const wx=x+w+rndi(10,38),wh=rndi(80,170);
        walls.push({x:wx,y:FLOOR_Y-wh,w:12,h:wh});
        if(Math.random()<.6)anchors.push({x:wx+6+rndi(-12,70),y:FLOOR_Y-wh-rndi(45,95)});
      }

      if(Math.random()<.55)coins.push({x:x+w*.5+rndi(-16,16),y:FLOOR_Y+up-rndi(36,64),r:8,g:0});
      if(Math.random()<.22)boosts.push({x:x+w*.5+rndi(-20,20),y:FLOOR_Y+up-rndi(34,55),w:16,h:16,g:0});
      if(Math.random()<.42)hazards.push({x:x+w-rndi(10,30),y:FLOOR_Y+up-12,w:rndi(20,38),h:12});

      if(i%9===3){
        const py=FLOOR_Y-rndi(70,140);
        seg.push({x:x+rndi(25,55),y:py,w:rndi(90,140),h:14});
        if(Math.random()<.8)anchors.push({x:x+rndi(52,140),y:py-rndi(55,90)});
      }

      x+=w+gap;
      if(x>WORLD_W-240)break;
    }

    seg.sort((a,b)=>a.x-b.x);
    walls.sort((a,b)=>a.x-b.x);
    hazards.sort((a,b)=>a.x-b.x);
    anchors.sort((a,b)=>a.x-b.x);
  }

  function reset(full){
    s.dead=0;s.win=0;s.t=0;s.score=0;s.combo=0;s.comboT=0;s.x=130;s.y=250;s.dx=0;s.dy=0;s.onG=0;s.onW=0;
    s.face=1;s.coyote=0;s.jb=0;s.slide=0;s.grap=0;s.boost=0;s.notes=0;s.coffee=0;s.hint=11;s.ti=0;s.r='';camX=0;
    acts={l:0,r:0,d:0,j:0};
    if(full)addLevel();
  }

  function aabb(a,b){
    return a.x<a.x+b.w&&a.x+a.w>b.x&&a.y<a.y+b.h&&a.y+a.h>b.y;
  }

  function rectHit(ax,ay,aw,ah,b){
    return ax<b.x+b.w&&ax+aw>b.x&&ay<b.y+b.h&&ay+ah>b.y;
  }

  function kill(r){
    if(s.dead||s.win)return;
    s.dead=1;s.r=r||"Ouch";
    beep(110,.2,'sawtooth',.05);
    burst(s.x+s.w*.5,s.y+s.h*.5,'#ff6f89',20,s.dx*.1,s.dy*.1);
    if(s.score>s.best){s.best=s.score|0;localStorage.hd2_best=s.best}
  }

  function tutorialHit(name){
    if(s.ti>=TUT.length)return;
    if(TUT[s.ti].k!==name)return;
    s.ti++;
    s.score+=110;
    beep(760,.05,'triangle',.026);
    burst(s.x+s.w*.5,s.y-8,'#68efc8',9,0,-25);
  }

  function touchAction(name){
    tutorialHit(name);
    if(name==='left'||name==='right')return;
    if(s.comboT>0&&s.last&&s.last!==name){s.combo++;s.score+=s.combo*8}
    else s.combo=1;
    s.comboT=1.2;s.last=name;
  }

  function jump(fromWall){
    if(s.dead||s.win)return;
    if(fromWall){
      s.dy=-WALL_JUMP_Y;
      s.dx=(s.onW<0?1:-1)*WALL_JUMP_X;
      s.onW=0;
      touchAction('walljump');
      beep(540,.08,'triangle',.032);
      burst(s.x+s.w*.5,s.y+s.h*.5,'#86b8ff',8,0,-30);
      return;
    }
    if(s.onG||s.coyote>0){
      s.dy=-JUMP_V;s.onG=0;s.coyote=0;
      touchAction('jump');
      beep(420,.08,'triangle',.03);
      burst(s.x+s.w*.5,s.y+s.h,'#adc4ef',6,0,20);
    }
  }

  function startSlide(){
    if(s.dead||s.win||s.slide>0||!s.onG)return;
    s.slide=.42;
    touchAction('slide');
    beep(220,.09,'square',.026);
    burst(s.x+s.w*.4,s.y+s.h,'#95a8d3',8,s.dx*.1,20);
  }

  function attachGrapple(){
    if(!s.hold||s.dead||s.win||s.grap)return;
    let best=null,bd=170;
    const px=s.x+s.w*.5,py=s.y+s.h*.3;
    for(let i=0;i<anchors.length;i++){
      const a=anchors[i];
      const dx=a.x-px,dy=a.y-py;
      const d=Math.hypot(dx,dy);
      if(d<bd&&dy<-8&&a.x>px-120&&a.x<px+220){bd=d;best=a}
    }
    if(best){
      s.grap=1;s.gx=best.x;s.gy=best.y;s.gl=bd;
      touchAction('grapple');
      beep(700,.05,'square',.03);
      burst(px,py,'#ffd575',10,0,0);
    }
  }

  function solveWorld(dt){
    const oldX=s.x,oldY=s.y;

    // horizontal intent
    const dir=(acts.r?1:0)-(acts.l?1:0);
    if(dir){
      s.face=dir;
      s.dx+=dir*(s.onG?MOVE_ACC:AIR_ACC)*dt;
    }else{
      const d=(s.onG?MOVE_DEC:MOVE_DEC*.4)*dt;
      if(Math.abs(s.dx)<=d)s.dx=0; else s.dx-=Math.sign(s.dx)*d;
    }

    if(s.boost>0){s.boost-=dt*120;s.dx+=s.face*300*dt}

    s.dx=clamp(s.dx,-MAX_DX-(s.boost>0?130:0),MAX_DX+(s.boost>0?130:0));

    // jump buffer
    if(s.jb>0)s.jb-=dt;

    attachGrapple();

    if(s.grap){
      const px=s.x+s.w*.5,py=s.y+s.h*.5;
      let rx=px-s.gx,ry=py-s.gy;
      let dist=Math.hypot(rx,ry)||1;

      // pull
      const pull=s.hold?780:240;
      s.dx+=(-rx/dist)*pull*dt;
      s.dy+=(-ry/dist)*pull*dt;

      // rope constraint
      rx=(s.x+s.w*.5)-s.gx;
      ry=(s.y+s.h*.5)-s.gy;
      dist=Math.hypot(rx,ry)||1;
      if(dist>s.gl){
        const nx=rx/dist,ny=ry/dist;
        const cx=s.gx+nx*s.gl,cy=s.gy+ny*s.gl;
        s.x=cx-s.w*.5;
        s.y=cy-s.h*.5;
        const vn=s.dx*nx+s.dy*ny;
        if(vn>0){s.dx-=vn*nx;s.dy-=vn*ny}
      }

      if(!s.hold&&Math.random()<.03)burst(s.x+s.w*.5,s.y+s.h*.4,'#f7d37b',1,s.dx*.05,s.dy*.05);
      if(!s.hold&&Math.hypot(s.x+s.w*.5-s.gx,s.y+s.h*.5-s.gy)<s.gl*.85)s.grap=0;
    }

    s.dy+=GRAV*dt;

    // slide
    if(s.slide>0)s.slide-=dt;
    const ph=s.slide>0?16:s.h;

    s.onG=0;s.onW=0;

    // move X
    s.x+=s.dx*dt;

    for(let i=0;i<walls.length;i++){
      const w=walls[i];
      if(rectHit(s.x,s.y,s.w,ph,w)){
        if(oldX+s.w<=w.x){
          s.x=w.x-s.w;s.dx=Math.min(0,s.dx);s.onW=1;
        }else if(oldX>=w.x+w.w){
          s.x=w.x+w.w;s.dx=Math.max(0,s.dx);s.onW=-1;
        }
      }
    }

    for(let i=0;i<seg.length;i++){
      const g=seg[i];
      if(rectHit(s.x,s.y,s.w,ph,g)){
        if(oldX+s.w<=g.x){s.x=g.x-s.w;s.dx=0;s.onW=1}
        else if(oldX>=g.x+g.w){s.x=g.x+g.w;s.dx=0;s.onW=-1}
      }
    }

    // move Y
    s.y+=s.dy*dt;

    for(let i=0;i<seg.length;i++){
      const g=seg[i];
      if(rectHit(s.x,s.y,s.w,ph,g)){
        if(oldY+ph<=g.y){
          s.y=g.y-ph;s.dy=0;s.onG=1;s.grap=0;
        }else if(oldY>=g.y+g.h){
          s.y=g.y+g.h;s.dy=Math.max(0,s.dy);
        }
      }
    }

    for(let i=0;i<walls.length;i++){
      const w=walls[i];
      if(rectHit(s.x,s.y,s.w,ph,w)){
        if(oldY+ph<=w.y){s.y=w.y-ph;s.dy=0;s.onG=1;s.grap=0}
        else if(oldY>=w.y+w.h){s.y=w.y+w.h;s.dy=Math.max(0,s.dy)}
      }
    }

    if(s.onG)s.coyote=.09; else s.coyote=Math.max(0,s.coyote-dt);

    if(s.onW&&!s.onG&&s.dy>180){
      s.dy=lerp(s.dy,165,.35);
    }

    // jump execute
    if(s.jb>0){
      if(s.onW&&!s.onG){jump(1);s.jb=0}
      else if(s.onG||s.coyote>0){jump(0);s.jb=0}
    }

    // hazards
    for(let i=0;i<hazards.length;i++){
      const h=hazards[i];
      if(rectHit(s.x,s.y,s.w,ph,h))kill('Hit obstacle');
    }

    // pickups
    for(let i=0;i<coins.length;i++){
      const p=coins[i];
      if(p.g)continue;
      if(rectHit(s.x,s.y,s.w,ph,{x:p.x-p.r,y:p.y-p.r,w:p.r*2,h:p.r*2})){
        p.g=1;s.score+=75;s.notes++;touchAction('note');beep(900,.04,'triangle',.025);
        burst(p.x,p.y,'#ffe48a',8,0,-20);
      }
    }

    for(let i=0;i<boosts.length;i++){
      const b=boosts[i];
      if(b.g)continue;
      if(rectHit(s.x,s.y,s.w,ph,b)){
        b.g=1;s.coffee++;s.boost+=170;s.score+=55;touchAction('coffee');beep(320,.07,'square',.028);
        burst(b.x+b.w*.5,b.y+b.h*.5,'#ffb26f',10,s.dx*.08,-10);
      }
    }

    if(s.y>H+260||s.x<-120)kill('Fell off');
    if(s.x>WORLD_W-170){s.win=1;s.dead=1;s.r='Defense saved';if(s.score>s.best){s.best=s.score|0;localStorage.hd2_best=s.best};beep(690,.09,'triangle',.03)}

    s.score=(s.score+Math.max(0,s.dx)*dt*.22)|0;
  }

  function update(dt){
    s.t+=dt;
    if(!s.start||s.dead){
      if(s.comboT>0)s.comboT-=dt;
    }else{
      if(s.hint>0)s.hint-=dt;
      if(s.comboT>0)s.comboT-=dt; else s.combo=0;
      solveWorld(dt);
    }

    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];p.t-=dt;p.x+=p.dx*dt;p.y+=p.dy*dt;p.dy+=470*dt;if(p.t<=0)particles.splice(i,1);
    }

    const target=s.x-W*.38;
    camX=clamp(lerp(camX,target,Math.min(1,dt*6)),0,WORLD_W-W);
  }

  function screenRect(x,y,w,h){
    ctx.fillRect((x-camX)|0,y|0,w|0,h|0);
  }

  function drawBG(){
    const g=ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#2a4a70');g.addColorStop(.55,'#17263d');g.addColorStop(1,'#0b0f16');
    ctx.fillStyle=g;ctx.fillRect(0,0,W,H);

    // distant skyline
    ctx.fillStyle='#111b2c';
    for(let i=0;i<16;i++){
      const w=80+(i*17%70),h=80+(i*53%130);
      const x=(i*170-camX*.25)% (W+260)-120;
      ctx.fillRect(x,H-220-h,w,h);
      ctx.fillStyle='#223754';
      for(let y=H-220-h+8;y<H-220-6;y+=16)ctx.fillRect(x+8,y,5,6);
      ctx.fillStyle='#111b2c';
    }

    ctx.fillStyle='#121926';
    ctx.fillRect(0,FLOOR_Y+44,W,H-FLOOR_Y);
  }

  function drawWorld(){
    // grounds
    ctx.fillStyle='#384760';
    for(let i=0;i<seg.length;i++){
      const g=seg[i];
      if(g.x+g.w<camX-40||g.x>camX+W+40)continue;
      screenRect(g.x,g.y,g.w,g.h);
      ctx.fillStyle='#5a6e93';screenRect(g.x,g.y,g.w,5);ctx.fillStyle='#384760';
    }

    // walls
    for(let i=0;i<walls.length;i++){
      const w=walls[i];if(w.x+w.w<camX-30||w.x>camX+W+30)continue;
      ctx.fillStyle='#2b364c';screenRect(w.x,w.y,w.w,w.h);
      ctx.fillStyle='#65779d';screenRect(w.x,w.y,4,w.h);
    }

    // hazards
    for(let i=0;i<hazards.length;i++){
      const h=hazards[i];if(h.x+h.w<camX-20||h.x>camX+W+20)continue;
      ctx.fillStyle='#d63b58';screenRect(h.x,h.y,h.w,h.h);
      ctx.fillStyle='#ff7e98';screenRect(h.x,h.y,h.w,3);
    }

    // anchors
    for(let i=0;i<anchors.length;i++){
      const a=anchors[i];if(a.x<camX-30||a.x>camX+W+30)continue;
      const sx=a.x-camX,sy=a.y;
      const pulse=1+Math.sin(s.t*8+i)*.15;
      ctx.strokeStyle='#ffd06a';ctx.lineWidth=2.6;
      ctx.beginPath();ctx.arc(sx,sy,10*pulse,0,Math.PI*2);ctx.stroke();
      ctx.fillStyle='#fff3c2';ctx.beginPath();ctx.arc(sx,sy,2.6,0,Math.PI*2);ctx.fill();
    }

    // pickups
    for(let i=0;i<coins.length;i++){
      const p=coins[i];if(p.g||p.x<camX-30||p.x>camX+W+30)continue;
      const bob=Math.sin(s.t*5+i)*2;
      ctx.fillStyle='#ffd970';ctx.beginPath();ctx.arc((p.x-camX)|0,p.y+bob,p.r,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fff4be';ctx.fillRect((p.x-camX-2)|0,(p.y+bob-2)|0,4,4);
    }

    for(let i=0;i<boosts.length;i++){
      const b=boosts[i];if(b.g||b.x<camX-30||b.x>camX+W+30)continue;
      const bob=Math.sin(s.t*6+i)*2;
      ctx.fillStyle='#ffb572';screenRect(b.x,b.y+bob,b.w,b.h);
      ctx.strokeStyle='#ffd9b5';ctx.lineWidth=2;ctx.beginPath();ctx.arc((b.x-camX+b.w)|0,b.y+bob+b.h*.45,4,-1.3,1.3);ctx.stroke();
    }
  }

  function pickDogSprite(){
    if(s.slide>0)return s.face>0?imgs.se:imgs.sw;
    if(!s.onG){
      if(s.dy<-20)return s.face>0?imgs.ne:imgs.nw;
      if(s.dy>70)return s.face>0?imgs.se:imgs.sw;
      return s.face>0?imgs.e:imgs.w;
    }
    return s.face>0?imgs.e:imgs.w;
  }

  function drawDog(){
    const spr=pickDogSprite();
    const sx=(s.x-camX)|0,sy=s.y|0;

    if(s.grap){
      ctx.strokeStyle='#f3dd97';ctx.lineWidth=2.4;
      ctx.beginPath();ctx.moveTo(sx+s.w*.55,sy+s.h*.35);ctx.lineTo(s.gx-camX,s.gy);ctx.stroke();
    }

    const sh=Math.max(12,s.w*(s.slide>0?.95:1));
    ctx.fillStyle='rgba(0,0,0,.35)';ctx.beginPath();ctx.ellipse(sx+s.w*.5,FLOOR_Y+46,sh,6,0,0,Math.PI*2);ctx.fill();

    if(spr&&spr.complete){
      const w=s.slide>0?42:48,h=s.slide>0?22:28;
      ctx.drawImage(spr,sx-7,sy-6,w,h);
    }else{
      ctx.fillStyle='#080a0e';ctx.fillRect(sx,sy,s.w,s.h);
      ctx.fillStyle='#db3152';ctx.fillRect(sx+s.w*.58,sy+s.h*.18,9,4);
    }

    if(s.boost>0){
      ctx.fillStyle='rgba(255,198,108,.3)';
      ctx.beginPath();ctx.ellipse(sx-4,sy+s.h*.65,14+Math.sin(s.t*12)*3,8,0,0,Math.PI*2);ctx.fill();
    }
  }

  function drawParticles(){
    for(let i=0;i<particles.length;i++){
      const p=particles[i];
      ctx.globalAlpha=clamp(p.t*2.7,0,1);
      ctx.fillStyle=p.c;ctx.fillRect((p.x-camX)|0,p.y|0,3,3);
    }
    ctx.globalAlpha=1;
  }

  function hud(){
    ctx.fillStyle='rgba(10,14,22,.72)';ctx.fillRect(10,10,W-20,64);
    ctx.fillStyle='#f2f6ff';ctx.font='700 17px Trebuchet MS,sans-serif';ctx.fillText('HAMISH MOVEMENT TRIAL',20,33);
    ctx.font='600 15px Trebuchet MS,sans-serif';
    ctx.fillStyle='#9ac4ff';ctx.fillText('Score '+(s.score|0),20,57);
    ctx.fillStyle='#ffd970';ctx.fillText('Notes '+s.notes,125,57);
    ctx.fillStyle='#ffb56f';ctx.fillText('Coffee '+s.coffee,214,57);
    ctx.fillStyle='#dce8ff';ctx.fillText('Best '+s.best,W-95,57);

    if(s.combo>1&&s.comboT>0){
      ctx.fillStyle='rgba(8,12,19,.8)';ctx.fillRect(W*.5-64,86,128,32);
      ctx.fillStyle='#68efc8';ctx.font='700 18px Trebuchet MS,sans-serif';ctx.fillText('x'+s.combo+' COMBO',W*.5-47,108);
    }

    if(s.start&&!s.dead){
      const tutDone=s.ti>=TUT.length;
      const tutMsg=tutDone?'Tutorial complete. Keep flowing.':'Objective: '+TUT[s.ti].t;
      ctx.fillStyle='rgba(8,12,19,.82)';ctx.fillRect(14,84,W-28,44);
      ctx.fillStyle=tutDone?'#68efc8':'#f7fbff';ctx.font='700 16px Trebuchet MS,sans-serif';ctx.fillText(tutMsg,24,111);
      for(let i=0;i<TUT.length;i++){
        ctx.fillStyle=i<s.ti?'#68efc8':'#33455f';
        ctx.fillRect(20+i*((W-60)/TUT.length),134,(W-74)/TUT.length,6);
      }
    }

    if(s.start&&!s.dead){
      const y=H-88,w=(W-24)/3;
      ctx.fillStyle='rgba(8,12,19,.66)';ctx.fillRect(6,y,w,62);ctx.fillRect(12+w,y,w,62);ctx.fillRect(18+w*2,y,w,62);
      ctx.fillStyle='#dcebff';ctx.font='700 14px Trebuchet MS,sans-serif';
      ctx.fillText('LEFT',20,y+26);ctx.fillText('JUMP',w+24,y+26);ctx.fillText('RIGHT',w*2+28,y+26);
      ctx.font='600 12px Trebuchet MS,sans-serif';
      ctx.fillStyle='#9ec8ff';ctx.fillText('hold to run',20,y+46);ctx.fillText('tap center',w+24,y+46);ctx.fillText('hold to run',w*2+28,y+46);
      ctx.fillStyle='rgba(8,12,19,.78)';ctx.fillRect(14,H-124,W-28,30);
      ctx.fillStyle='#ffd06a';ctx.font='700 13px Trebuchet MS,sans-serif';
      ctx.fillText('SWIPE DOWN = SLIDE     HOLD NEAR YELLOW RING = GRAPPLE',22,H-103);
    }

    if(!s.start){
      ctx.fillStyle='rgba(7,10,16,.86)';ctx.fillRect(20,H*.2,W-40,H*.6);
      ctx.fillStyle='#fff';ctx.font='700 35px Trebuchet MS,sans-serif';ctx.fillText('WHAT THE',W*.5-95,H*.34);
      ctx.fillStyle='#f04561';ctx.fillText('DOG DOING?',W*.5-105,H*.40);
      ctx.fillStyle='#dbe7ff';ctx.font='600 20px Trebuchet MS,sans-serif';
      ctx.fillText('Pure 2D movement challenge',W*.5-133,H*.49);
      ctx.font='600 17px Trebuchet MS,sans-serif';
      ctx.fillText('1) Hold RIGHT/LEFT zone to run',W*.5-126,H*.56);
      ctx.fillText('2) Tap CENTER zone to jump (and wall-jump)',W*.5-145,H*.61);
      ctx.fillText('3) Swipe DOWN to slide under bars',W*.5-126,H*.66);
      ctx.fillText('4) HOLD near yellow ring to grapple',W*.5-130,H*.71);
      ctx.fillStyle='#68efc8';ctx.font='700 24px Trebuchet MS,sans-serif';ctx.fillText('Tap to start',W*.5-58,H*.75);
    }

    if(s.dead){
      ctx.fillStyle='rgba(5,8,13,.86)';ctx.fillRect(24,H*.23,W-48,H*.5);
      ctx.fillStyle=s.win?'#68efc8':'#ff8398';ctx.font='700 31px Trebuchet MS,sans-serif';
      ctx.fillText(s.win?'THESIS SAVED':'TRY AGAIN',W*.5-(s.win?88:75),H*.37);
      ctx.fillStyle='#dce7ff';ctx.font='600 21px Trebuchet MS,sans-serif';ctx.fillText('Score '+(s.score|0),W*.5-60,H*.46);
      ctx.fillText('Best '+s.best,W*.5-48,H*.52);
      ctx.fillStyle='#ffd06a';ctx.fillText(s.r||'Keep moving',W*.5-76,H*.58);
      ctx.fillStyle='#68efc8';ctx.font='700 24px Trebuchet MS,sans-serif';ctx.fillText('Tap to retry',W*.5-66,H*.67);
    }
  }

  function render(){
    drawBG();
    drawWorld();
    drawDog();
    drawParticles();
    hud();
  }

  function frame(ts){
    if(!last)last=ts;
    let dt=(ts-last)*.001;last=ts;dt=clamp(dt,0,.034);
    update(dt);render();
    requestAnimationFrame(frame);
  }

  function ptrDown(e){
    if(pid>=0&&pid!==e.pointerId)return;
    pid=e.pointerId;cnv.setPointerCapture(pid);
    downX=e.clientX;downY=e.clientY;downT=performance.now();

    if(!audio)audio=new (window.AudioContext||window.webkitAudioContext)();

    if(!s.start){s.start=1;reset(1);beep(430,.05,'triangle',.025);return}
    if(s.dead){reset(0);beep(360,.05,'triangle',.02);return}

    s.hold=1;

    const x=e.clientX,y=e.clientY;
    if(y>H*.33){
      if(x<W*.33){acts.l=1;acts.r=0;touchAction('left')}
      else if(x>W*.67){acts.r=1;acts.l=0;touchAction('right')}
      else{s.jb=.13}
    }
  }

  function ptrMove(e){
    if(pid!==e.pointerId||s.dead||!s.start)return;
    const dy=e.clientY-downY,dx=e.clientX-downX;
    if(dy>38&&Math.abs(dx)<88){startSlide();downY=e.clientY+999}

    // lane adjust while holding side
    if(e.clientX<W*.26){acts.l=1;acts.r=0}
    else if(e.clientX>W*.74){acts.r=1;acts.l=0}
  }

  function ptrUp(e){
    if(pid!==e.pointerId)return;
    const dt=(performance.now()-downT)*.001,dy=e.clientY-downY,dx=e.clientX-downX;
    if(!s.dead&&s.start&&dy>35&&Math.abs(dx)<90&&dt<.42)startSlide();
    if(dt<.25&&Math.abs(dx)<24&&Math.abs(dy)<24&&e.clientX>W*.33&&e.clientX<W*.67)s.jb=.13;

    s.hold=0;s.grap=0;
    acts.l=0;acts.r=0;

    if(cnv.hasPointerCapture(pid))cnv.releasePointerCapture(pid);
    pid=-1;
  }

  addEventListener('resize',resize);
  cnv.addEventListener('pointerdown',ptrDown,{passive:1});
  cnv.addEventListener('pointermove',ptrMove,{passive:1});
  cnv.addEventListener('pointerup',ptrUp,{passive:1});
  cnv.addEventListener('pointercancel',ptrUp,{passive:1});

  resize();
  addLevel();
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
